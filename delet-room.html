<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Delete / Hide / Edit Room</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 30px auto;
      background: #fff0f0;
      color: #d32f2f;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #d32f2f;
    }
    h2 { text-align: center; margin-bottom: 20px; }
    .room-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .room-card {
      border: 2px solid #d32f2f;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 3px 8px rgba(211, 47, 47, 0.3);
      display: flex;
      flex-direction: column;
    }
    .room-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .room-info {
      padding: 15px;
      flex-grow: 1;
    }
    .room-title {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .room-price {
      color: #b71c1c;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .room-details {
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    button {
      background: #d32f2f;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    button:hover { background: #b71c1c; }
    .hide-btn { background: #f57c00; }
    .hide-btn:hover { background: #e65100; }
    .edit-btn { background: #1976d2; }
    .edit-btn:hover { background: #0d47a1; }
    .msg {
      font-weight: bold;
      margin-top: 10px;
      text-align: center;
    }
    .msg.success { color: green; }
    .msg.error { color: red; }

    /* Edit Panel */
    #editPanel {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 20px;
      border: 2px solid #d32f2f;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 999;
      width: 400px;
      max-width: 95%;
    }
    #editPanel h3 { margin-top: 0; }
    #editPanel label { display:block; margin-top:10px; font-weight:bold; }
    #editPanel input, #editPanel textarea, #editPanel select {
      width: 100%; padding: 8px; margin-top:5px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    #editPanel button { margin-top:15px; }
  </style>
</head>
<body>

  <h2>Delete / Hide / Edit Rooms</h2>
  <div id="message" class="msg"></div>
  <div class="room-list" id="roomList"></div>

  <!-- Edit Panel -->
  <div id="editPanel">
    <h3>Edit Room</h3>
    <form id="editRoomForm">
      <input type="hidden" id="editId">

      <label>Title</label>
      <input type="text" id="editTitle" required>

      <label>Price</label>
      <input type="number" id="editPrice" required>

      <label>AC / Non-AC</label>
      <select id="editAc">
        <option value="AC">AC</option>
        <option value="Non-AC">Non-AC</option>
      </select>

      <label>Location</label>
      <input type="text" id="editLocation">

      <label>Description</label>
      <textarea id="editDesc"></textarea>

      <label>Photo URL</label>
      <input type="text" id="editPhoto">

      <button type="submit">üíæ Save Changes</button>
      <button type="button" onclick="closeEditPanel()">‚ùå Cancel</button>
    </form>
  </div>

 <script>
  const API_BASE = "https://roomofy-app-1.onrender.com/api";
  const roomListDiv = document.getElementById('roomList');
  const msgDiv = document.getElementById('message');
  const editPanel = document.getElementById('editPanel');

  // Fetch and display rooms
  async function fetchRooms() {
    try {
      const res = await fetch(`${API_BASE}/rooms?showHidden=true`);
      const rooms = await res.json();

      if (!res.ok || rooms.length === 0) {
        roomListDiv.innerHTML = '<p>No rooms available.</p>';
        return;
      }

      roomListDiv.innerHTML = rooms.map(room => `
        <div class="room-card" id="room-${room._id}">
          <img src="${room.photos && room.photos.length > 0 ? room.photos[0] : 'https://via.placeholder.com/280x180?text=No+Image'}" alt="${room.title}" />

          <div class="room-info">
            <div class="room-title">${room.title}</div>
            <div class="room-price">‚Çπ${room.price}</div>
            <div class="room-details">${room.ac} | ${room.location}</div>
            <button onclick="deleteRoom('${room._id}')">Delete</button>
            <button class="hide-btn" onclick="toggleHide('${room._id}', ${!room.isHidden})">
              ${room.isHidden ? 'Unhide' : 'Hide'}
            </button>
            <button class="edit-btn" onclick="openEditPanel(${JSON.stringify(room).replace(/"/g,'&quot;')})">Edit</button>
          </div>
        </div>
      `).join('');
    } catch (err) {
      msgDiv.textContent = 'Network error. Please try again later.';
      msgDiv.className = 'msg error';
    }
  }

  // Delete a room
  async function deleteRoom(id) {
    if (!confirm('Are you sure you want to delete this room?')) return;

    try {
      const res = await fetch(`${API_BASE}/rooms/${id}`, { method: 'DELETE' });
      const data = await res.json();

      if (res.ok) {
        document.getElementById(`room-${id}`).remove();
        msgDiv.textContent = 'Room deleted successfully!';
        msgDiv.className = 'msg success';
      } else {
        msgDiv.textContent = data.error || 'Failed to delete room';
        msgDiv.className = 'msg error';
      }
    } catch (err) {
      msgDiv.textContent = 'Network error. Please try again later.';
      msgDiv.className = 'msg error';
    }
  }

  // Hide / Unhide a room
  async function toggleHide(id, hideStatus) {
    try {
      const res = await fetch(`${API_BASE}/rooms/${id}/hide`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isHidden: hideStatus })
      });
      const data = await res.json();

      if (res.ok) {
        msgDiv.textContent = `Room ${hideStatus ? 'hidden' : 'unhidden'} successfully!`;
        msgDiv.className = 'msg success';
        fetchRooms(); // refresh list
      } else {
        msgDiv.textContent = data.error || 'Failed to update hide status';
        msgDiv.className = 'msg error';
      }
    } catch (err) {
      msgDiv.textContent = 'Network error. Please try again later.';
      msgDiv.className = 'msg error';
    }
  }

  // Open Edit Panel
  function openEditPanel(room) {
    editPanel.style.display = "block";
    document.getElementById("editId").value = room._id;
    document.getElementById("editTitle").value = room.title || "";
    document.getElementById("editPrice").value = room.price || "";
    document.getElementById("editAc").value = room.ac || "AC";
    document.getElementById("editLocation").value = room.location || "";
    document.getElementById("editDesc").value = room.description || "";
    document.getElementById("editPhoto").value = room.photos && room.photos.length > 0 ? room.photos[0] : "";
  }

  // Close Edit Panel
  function closeEditPanel() {
    editPanel.style.display = "none";
  }

  // ‚úÖ Submit Edit Form (fixed)
  document.getElementById("editRoomForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("editId").value;

    // Build FormData instead of JSON
    const formData = new FormData();
    formData.append("title", document.getElementById("editTitle").value.trim());
    formData.append("price", document.getElementById("editPrice").value.trim());
    formData.append("ac", document.getElementById("editAc").value);
    formData.append("location", document.getElementById("editLocation").value.trim());
    formData.append("description", document.getElementById("editDesc").value.trim());

    // Photo URL support
    const photoUrl = document.getElementById("editPhoto").value.trim();
    if (photoUrl) {
      formData.append("photoUrls", photoUrl);
    }

    try {
      const res = await fetch(`${API_BASE}/rooms/${id}`, {
        method: "PUT",
        body: formData // ‚úÖ no headers needed, browser will set multipart/form-data
      });
      const result = await res.json();

      if (res.ok) {
        msgDiv.textContent = "Room updated successfully!";
        msgDiv.className = "msg success";
        closeEditPanel();
        fetchRooms();
      } else {
        msgDiv.textContent = result.error || result.message || "Failed to update room.";
        msgDiv.className = "msg error";
      }
    } catch (err) {
      msgDiv.textContent = "Network error. Please try again later.";
      msgDiv.className = "msg error";
    }
  });

  fetchRooms();
</script>

</body>
</html>
